---

- name: Install a list of packages
  apt:
    name: "{{ packages }}"
    state: present
  vars:
    packages:
    - unzip
    - zsh
    - wget
    - curl
    - apt-transport-https
    - ca-certificates
    - gnupg-agent
    - software-properties-common
       
- name: Add an gpg signing Docker
  apt_key:
    url: https://download.docker.com/linux/ubuntu/gpg
    state: present

- name: Add docker repository
  apt_repository:
    repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu bionic stable
    state: present

- name: Install Docker
  apt:
    name: "{{ packages_docker }}"
    state: present
    update_cache: yes
  vars:
    packages_docker:
    - docker-ce={{ docker_version }}
    - docker-ce-cli={{ docker_version }}
    - containerd.io
    
- name: Add the user appending the group docker to the user's groups
  user:
    name: "{{ ansible_user }}"
    groups: docker
    append: yes

- name: Make sure a service is running
  systemd:
    state: started
    name: docker

- name: Enabling some module
  blockinfile:
    path: /etc/modules-load.d/modules.conf
    block: |
      ip6_udp_tunnel
      ip_set
      ip_set_hash_ip
      ip_set_hash_net
      iptable_mangle
      iptable_raw
      udp_tunnel
      veth
      vxlan
      xt_comment
      xt_mark
      xt_multiport
      xt_nat
      xt_recent
      xt_set
      xt_statistic
      xt_tcpudp

- name: Enabling sysctl.conf
  sysctl:
    name: "{{ item }}"
    value: '1'
    sysctl_set: yes
    state: present
    reload: yes    
    sysctl_file: /etc/sysctl.conf
  with_items:
    - net.bridge.bridge-nf-call-iptables
    - net.ipv4.ip_forward

- name: Enabling TCP Forwarding in SSHD
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#AllowTcpForwarding'
    line: AllowTcpForwarding yes
    
- name: Restart SSH service
  systemd:
    state: restarted
    daemon_reload: yes
    name: ssh    

- name: Reboot the Machine
  reboot:
    reboot_timeout: 60    